#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<'EOF'
Usage:
  winrun [--no-stdin] [--] <command-or-path> [args...]

Runs a Windows command from WSL via cmd.exe, ensuring the Windows working
directory matches the current WSL directory.

Options:
  --no-stdin   Redirect stdin from /dev/null (non-interactive safe).
  -h, --help   Show this help.

Examples:
  tool/agent/winrun --no-stdin -- ./.fvm/flutter_sdk/bin/dart.bat run custom_lint
  tool/agent/winrun --no-stdin -- ./.fvm/flutter_sdk/bin/dart.bat run tool/verify.dart --env dev
EOF
}

no_stdin=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --no-stdin)
      no_stdin=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      break
      ;;
  esac
done

if [[ $# -lt 1 ]]; then
  usage
  exit 2
fi

if ! command -v cmd.exe >/dev/null 2>&1; then
  echo "ERROR: cmd.exe not found. This wrapper is intended for WSL Windows interop." >&2
  exit 1
fi

if ! command -v wslpath >/dev/null 2>&1; then
  echo "ERROR: wslpath not found. This wrapper is intended for WSL." >&2
  exit 1
fi

escape_windows_arg() {
  local value="$1"
  if [[ -z "$value" ]]; then
    printf '""'
    return
  fi

  local needs_quotes=0
  if [[ "$value" == *" "* || "$value" == *'"'* || "$value" == *"&"* ]]; then
    needs_quotes=1
  fi

  if [[ $needs_quotes -eq 0 ]]; then
    printf '%s' "$value"
    return
  fi

  printf '"%s"' "${value//\"/\\\"}"
}

win_cwd="$(wslpath -w "$PWD")"

exe="$1"
shift

if [[ -e "$exe" ]]; then
  exe="$(wslpath -w "$exe")"
fi

cmd="cd /d $(escape_windows_arg "$win_cwd") && $(escape_windows_arg "$exe")"
for arg in "$@"; do
  cmd="$cmd $(escape_windows_arg "$arg")"
done

if [[ $no_stdin -eq 1 ]]; then
  exec cmd.exe /C "$cmd" < /dev/null
else
  exec cmd.exe /C "$cmd"
fi

