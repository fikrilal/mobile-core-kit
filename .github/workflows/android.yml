name: Android CI & Release (template)

# NOTE: This workflow is shipped as a template only.
on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-test-bundle:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      KEYSTORE_PATH: /tmp/upload-keystore.jks
      KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      PLAY_CONFIG_PATH: /tmp/play-credentials.json
      PLAY_TRACK: internal
      PLAY_RELEASE_STATUS: draft
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore env YAML configs
        run: |
          restore_env() {
            local content="$1"
            local destination="$2"
            local strict_mode="${STRICT_ENV_CONFIG:-false}"
            local source_label="repo"
            if [[ -z "$content" ]]; then
              if [[ "$strict_mode" == "true" ]]; then
                echo "::error::Secret for $destination not provided and strict env mode is enabled."
                exit 1
              fi
              echo "::warning::Secret for $destination not provided; keeping repo copy."
            else
              mkdir -p "$(dirname "$destination")"
              printf '%s\n' "$content" > "$destination"
              source_label="secret"
              echo "Wrote $destination from secret."
            fi
            if [[ ! -s "$destination" ]]; then
              echo "::error::$destination is missing or empty after restore."
              exit 1
            fi
            echo "Resolved $destination from $source_label."
          }

          restore_env "$ENV_DEV_YAML" .env/dev.yaml
          restore_env "$ENV_STAGING_YAML" .env/staging.yaml
          restore_env "$ENV_PROD_YAML" .env/prod.yaml
        env:
          ENV_DEV_YAML: ${{ secrets.ENV_DEV_YAML }}
          ENV_STAGING_YAML: ${{ secrets.ENV_STAGING_YAML }}
          ENV_PROD_YAML: ${{ secrets.ENV_PROD_YAML }}
          STRICT_ENV_CONFIG: ${{ github.event_name != 'pull_request' && 'true' || 'false' }}

      - name: Restore google-services.json
        run: |
          if [[ -n "$GOOGLE_SERVICES_JSON" ]]; then
            printf '%s\n' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
            echo "Wrote android/app/google-services.json from secret."
          elif [[ ! -f android/app/google-services.json ]]; then
            echo "google-services.json missing and no secret provided."
            exit 1
          else
            echo "Using committed android/app/google-services.json"
          fi
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}

      - name: Read Flutter version (.fvmrc)
        id: fvm
        run: |
          python - <<'PY'
          import os
          import json
          with open('.fvmrc', 'r', encoding='utf-8') as f:
            data = json.load(f)
          version = data.get('flutter')
          if not version:
            raise SystemExit('Missing "flutter" key in .fvmrc')
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as out:
            out.write(f"flutter_version={version}\n")
          PY

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.flutter_version }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Cache pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Lint plugin tests
        working-directory: packages/mobile_core_kit_lints
        run: |
          dart pub get
          dart test

      - name: Verify (canonical)
        run: dart run tool/verify.dart --env prod --check-codegen

      - name: Prepare upload keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$KEYSTORE_PATH"
          chmod 600 "$KEYSTORE_PATH"
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Prepare Play credentials (optional)
        if: ${{ secrets.PLAY_STORE_JSON != '' }}
        run: |
          printf '%s' "$PLAY_STORE_JSON" > "$PLAY_CONFIG_PATH"
          chmod 600 "$PLAY_CONFIG_PATH"
        env:
          PLAY_STORE_JSON: ${{ secrets.PLAY_STORE_JSON }}

      - name: Build app bundle (prod)
        if: ${{ github.event_name != 'pull_request' }}
        run: flutter build appbundle --release --flavor prod -t lib/main_prod.dart --dart-define=ENV=prod

      - name: Upload app bundle artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: appbundle-prod-release
          path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

      # NOTE (template author):
      # In my Orymu project I only pushed builds to Google Play as DRAFT and did the final
      # review/rollout manually from the Play Console. I keep the publish step commented out
      # here so this boilerplate behaves the same way by default.
      #
      # Once you add Gradle Play Publisher (GPP) and a play{} block to android/app/build.gradle.kts,
      # you can uncomment the step below if you want CI to upload straight to the internal track.
      # I still recommend leaving PLAY_RELEASE_STATUS=draft and promoting/releasing manually.
      #
      # - name: Publish to Play Internal track
      #   if: ${{ secrets.PLAY_STORE_JSON != '' }}
      #   working-directory: android
      #   env:
      #     DART_DEFINES: RU5WPXByb2Q= # base64 for ENV=prod
      #   run: ./gradlew :app:publishProdReleaseBundle -Ptarget=lib/main_prod.dart -Pdart-defines=$DART_DEFINES --release-status $PLAY_RELEASE_STATUS

  ios-build-test:
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore env YAML configs
        run: |
          restore_env() {
            local content="$1"
            local destination="$2"
            local strict_mode="${STRICT_ENV_CONFIG:-false}"
            local source_label="repo"
            if [[ -z "$content" ]]; then
              if [[ "$strict_mode" == "true" ]]; then
                echo "::error::Secret for $destination not provided and strict env mode is enabled."
                exit 1
              fi
              echo "::warning::Secret for $destination not provided; keeping repo copy."
            else
              mkdir -p "$(dirname "$destination")"
              printf '%s\n' "$content" > "$destination"
              source_label="secret"
              echo "Wrote $destination from secret."
            fi
            if [[ ! -s "$destination" ]]; then
              echo "::error::$destination is missing or empty after restore."
              exit 1
            fi
            echo "Resolved $destination from $source_label."
          }

          restore_env "$ENV_DEV_YAML" .env/dev.yaml
          restore_env "$ENV_STAGING_YAML" .env/staging.yaml
          restore_env "$ENV_PROD_YAML" .env/prod.yaml
        env:
          ENV_DEV_YAML: ${{ secrets.ENV_DEV_YAML }}
          ENV_STAGING_YAML: ${{ secrets.ENV_STAGING_YAML }}
          ENV_PROD_YAML: ${{ secrets.ENV_PROD_YAML }}
          STRICT_ENV_CONFIG: ${{ github.event_name != 'pull_request' && 'true' || 'false' }}

      - name: Restore GoogleService-Info.plist (optional)
        run: |
          if [[ -n "$GOOGLE_SERVICE_INFO_PLIST" ]]; then
            printf '%s\n' "$GOOGLE_SERVICE_INFO_PLIST" > ios/Runner/GoogleService-Info.plist
            echo "Wrote ios/Runner/GoogleService-Info.plist from secret."
          elif [[ -f ios/Runner/GoogleService-Info.plist ]]; then
            echo "Using committed ios/Runner/GoogleService-Info.plist"
          else
            echo "GoogleService-Info.plist not provided; continuing (Firebase features may be disabled)."
          fi
        env:
          GOOGLE_SERVICE_INFO_PLIST: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST }}

      - name: Read Flutter version (.fvmrc)
        id: fvm
        run: |
          python - <<'PY'
          import os
          import json
          with open('.fvmrc', 'r', encoding='utf-8') as f:
            data = json.load(f)
          version = data.get('flutter')
          if not version:
            raise SystemExit('Missing "flutter" key in .fvmrc')
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as out:
            out.write(f"flutter_version={version}\n")
          PY

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.flutter_version }}
          cache: true

      - name: Lint plugin tests
        working-directory: packages/mobile_core_kit_lints
        run: |
          dart pub get
          dart test

      - name: Verify (canonical)
        run: dart run tool/verify.dart --env prod --check-codegen

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign -t lib/main_prod.dart --dart-define=ENV=prod
